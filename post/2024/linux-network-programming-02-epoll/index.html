<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://looechao.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://looechao.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://looechao.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://looechao.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://looechao.github.io/css/light.css' />
    <link rel="stylesheet" href='https://looechao.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://looechao.github.io/css/syntax.css' />
    <title>网络编程-EPOLL的使用 - looechao&#39;s blog</title>
    
    <link rel="icon" type="image/x-icon" href='/images/favicon.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="用EPOLL代替SELECT" />
<meta name="keywords"
  content='blog, google analytics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://looechao.github.io/post/2024/linux-network-programming-02-epoll/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="网络编程-EPOLL的使用 - looechao&#39;s blog" />
<meta name="twitter:description"
  content="用EPOLL代替SELECT" />
<meta name="twitter:site" content="https://looechao.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://looechao.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="网络编程-EPOLL的使用 - looechao&#39;s blog">
<meta property="og:description"
  content="用EPOLL代替SELECT" />
<meta property="og:url" content="https://looechao.github.io/post/2024/linux-network-programming-02-epoll/" />
<meta property="og:site_name" content="网络编程-EPOLL的使用" />
<meta property="og:image"
  content="https://looechao.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2024-06-17 15:38:13 &#43;0800 CST" />











</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://looechao.github.io/">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button" onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search" class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get" autocomplete="off">
            <label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text" class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://looechao.github.io/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="site:https://looechao.github.io/">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16" version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  
<div>
  <main>
    <div class="pagehead repohead instapaper_ignore readability-menu experiment-repo-nav pt-lg-4 "> 
                <div class="repohead-details-container clearfix container-lg p-responsive d-lg-block"> 
                    <div class="d-flex">
                        <h1 class="public css-truncate float-none flex-auto width-fit pl-0">
                            <a class="avatar mr-1" href="https://looechao.github.io/">
                            
                                <img src="/images/profile.png" class="avatar-user" width="26" height="26" title="Looe">
                            
                            </a>
                            
                            <strong itemprop="name"><a href="https://looechao.github.io/post/2024/linux-network-programming-02-epoll/">网络编程-EPOLL的使用</a></strong>

                            

                            
                            <div class="d-block text-small text-gray">
                                <span class="d-inline-block">
                                    Created at <time datetime="2024-06-17 15:38" class="no-wrap">
                                        2024-06-17 15:38</time>
                                </span>

                                
                                <span class="file-info-divider"></span>
                                <span class="d-inline-block">
                                    Updated at <time datetime="2024-07-04 20:17" class="no-wrap">
                                        2024-07-04 20:17</time>
                                    
                                </span>
                            </div>
                        </h1>
                    </div>
                </div>
            </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      2703 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/%E6%8A%80%E6%9C%AF">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      技术
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/linux">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Linux
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      网络编程
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/select">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      SELECT
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/epoll">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      EPOLL
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/%E6%B5%B7%E9%87%8F%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      海量连接处理
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h1 id="epoll">EPOLL</h1>
<h2 id="select的缺陷">select的缺陷</h2>
<ul>
<li>监听和就绪耦合</li>
<li>fd_set固定了大小为1024，不方便更改</li>
<li>每次调用select，都要把fd_set从用户态换成内核态，资源开销很大</li>
<li><strong>就绪机制不合理</strong>：轮询机制是用户层面的，在海量连接的状态下表现很差（海量连接，少量就绪）</li>
</ul>
<p>由以上缺陷可以引出了EPOLL，它解决了select的缺点，效率是十分高的，E for event, poll means 轮询，Epoll只用处理就绪的实践，<strong>只有Linux支持Epoll</strong>,mac和windows平台使用其他的多路复用</p>
<h2 id="操作流程">操作流程</h2>
<ol>
<li>
<p>建立一个文件对象：文件对象是分配在内核区的，所有操作对象都分配在epoll当中</p>
</li>
<li>
<p>Epoll文件对象有<strong>监听集合</strong>和<strong>就序集合</strong>构成，监听集合中的数据结构使用的是红黑树（<strong>大小无限制</strong>），保证了轮询效率 O(logN)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">epoll文件对象
</span></span><span class="line"><span class="cl"><span class="p">|</span>监听集合<span class="p">|</span>就绪集合<span class="p">|</span>      
</span></span><span class="line"><span class="cl">   <span class="p">|</span>        <span class="p">|</span>
</span></span><span class="line"><span class="cl"> 红黑树    线性表
</span></span><span class="line"><span class="cl">------------<span class="p">|</span>----
</span></span><span class="line"><span class="cl">            <span class="p">|</span>
</span></span><span class="line"><span class="cl">         <span class="o">[][][][]</span>
</span></span><span class="line"><span class="cl">用户只需要遍历用户集合即可，效率非常高
</span></span></code></pre></div></li>
<li>
<p>监听和就绪分离</p>
</li>
<li>
<p>用户只需要遍历就绪集合：保证了效率（尤其是在海量连接的情况下）</p>
</li>
</ol>
<h2 id="相关api">相关api</h2>
<ul>
<li>
<p>epoll_create 创建epoll文件对象，类比fd_set</p>
</li>
<li>
<p>epoll_ctl 增加监听，类比fd_zero/fd_set，可以放在循环外面</p>
</li>
<li>
<p>epoll_wait 陷入等待，类比select</p>
<p><strong>注意</strong>：要先准备好一个epoll_event数组来保存就绪事件，返回值是event的长度</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">                 <span class="err">文件对象</span>                   <span class="n">events数组</span>     <span class="err">数组长度</span>      <span class="err">超时时间</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>                          <span class="o">|</span>           <span class="o">|</span>             <span class="o">|</span>     
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">epoll_wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span><span class="kt">int</span> <span class="n">maxevents</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="err">描述有多少个</span><span class="n">fd就绪</span>
</span></span></code></pre></div><p>epoll_events数组将要存储就绪集合，当epoll_wait返回时，用户需要遍历events（这样做比遍历fd_set效率高很多）</p>
</li>
<li>
<p>epoll_ctl</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">                 <span class="err">文件对象</span>  <span class="err">操作</span>                   <span class="err">事件</span>
</span></span><span class="line"><span class="cl">                   <span class="o">|</span>       <span class="o">|</span>                     <span class="o">|</span> 
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">epoll_ctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">_Nullable</span> <span class="n">event</span><span class="p">);</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="案例-用epoll的即时聊天">案例-用epoll的即时聊天</h2>
<p>用epoll取代select操作的server</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;func.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ./2_azhen.c 192.168.68.128 1234
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ARGS_CHECK</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span> <span class="c1">//服务端地址的结构体初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//向ip结构体中传入ip地址和端口号参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="nf">htons</span><span class="p">(</span><span class="nf">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="nf">inet_addr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">bind</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ERROR_CHECK</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;bind&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">listen</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>   <span class="c1">//DDOS攻击的点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">clientAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">socklen_t</span> <span class="n">clientAddrSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientAddr</span><span class="p">);</span> <span class="c1">//该变量必须初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">netfd</span> <span class="o">=</span>  <span class="nf">accept</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clientAddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clientAddrSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;netfd = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">netfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;client ip = %s, port = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="nf">inet_ntoa</span><span class="p">(</span><span class="n">clientAddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">clientAddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//1 fd_set rdset;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">epfd</span> <span class="o">=</span> <span class="nf">epoll_create</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//epoll_create 取代定义 fd_set这个对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//2 设置监听 取代fd_set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//如果使用epoll_ctl 可以在循环外面使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">STDIN_FILENO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span> <span class="c1">//fd_set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//每次用完event之后都要重新赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">netfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="p">;</span> <span class="c1">//读事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">netfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//FD_ZERO(&amp;rdset);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//FD_SET(STDIN_FILENO, &amp;rdset);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//FD_SET(netfd, &amp;rdset);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//select(netfd+1, &amp;rdset, NULL, NULL, NULL);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 4 更换成epoll wait
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 现申请一个数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">readySet</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">readyNum</span> <span class="o">=</span> <span class="nf">epoll_wait</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">readySet</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//永久等待使用-1参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">// if(FD_ISSET(STDIN_FILENO, &amp;rdset)){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//     //memset(buf, 0, sizeof(buf));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//     bzero(buf, sizeof(buf));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//     ssize_t sret = read(STDIN_FILENO, buf, sizeof(buf));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//     //send(sockfd, buf, strlen(buf), 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//     send(netfd, buf, sret, 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">// if(FD_ISSET(netfd, &amp;rdset)){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//     bzero(buf, sizeof(buf));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//     ssize_t sret = recv(netfd, buf, sizeof(buf), 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//     printf(&#34;buf = %s\n&#34;, buf);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       
</span></span><span class="line"><span class="cl">       <span class="c1">//从就绪事件集合中进行操作 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">readyNum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">readySet</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">==</span> <span class="n">STDIN_FILENO</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//memset(buf, 0, sizeof(buf));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">bzero</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="kt">ssize_t</span> <span class="n">sret</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//send(sockfd, buf, strlen(buf), 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="n">sret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">send</span><span class="p">(</span><span class="n">netfd</span><span class="p">,</span> <span class="s">&#34;nishigehaoren&#34;</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">send</span><span class="p">(</span><span class="n">netfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sret</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">readySet</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">==</span> <span class="n">netfd</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                <span class="nf">bzero</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="kt">ssize_t</span> <span class="n">sret</span> <span class="o">=</span> <span class="nf">recv</span><span class="p">(</span><span class="n">netfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(</span><span class="n">sret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;hehe</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;buf = %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">end</span><span class="p">:</span>   
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">netfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>
<p>Q:说说你的高性能服务器？高性能体现在哪里？</p>
<p>A:我们曾经有一个老版本的项目使用select来写的，当用户量非常大的时候我们会发现性能表现会非常差，这时候我们采用了新的IO复用技术EPOLL来代替select，EPOLL处理时间只选择处理就绪事件，大大提高的海量连接下的性能表现</p>
</li>
</ul>
<h2 id="用epoll的聊天室">用epoll的聊天室</h2>
<p>4_server_chatroom_epoll:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">conn_s</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">netfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">is_alive</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">lastactive</span><span class="p">;</span> <span class="c1">//活跃时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="kt">conn_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ./4_server_chatroom_epoll 192.168.68.128 1234
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ARGS_CHECK</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span> <span class="c1">//服务端地址的结构体初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//向ip结构体中传入ip地址和端口号参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="nf">htons</span><span class="p">(</span><span class="nf">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="nf">inet_addr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">bind</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ERROR_CHECK</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;bind&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">listen</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>   <span class="c1">//DDOS攻击的点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="kt">conn_t</span> <span class="n">clientArr</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>  <span class="c1">//保存所有炼乳客户端的信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">curidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//保存下一个炼乳客户端的下标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">epfd</span> <span class="o">=</span> <span class="nf">epoll_create</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">sockfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="p">;</span> <span class="c1">//sockfd accept 对应的也是读行为
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">sockfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">time_t</span> <span class="n">curtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">readySet</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span> <span class="c1">//聊天室弄得大一点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//select(100, &amp;rdset, NULL, NULL, NULL);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">readyNum</span> <span class="o">=</span> <span class="nf">epoll_wait</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">readySet</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>  <span class="c1">//等待最多1000毫秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">readyNum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">readySet</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">==</span> <span class="n">sockfd</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">clientAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">socklen_t</span> <span class="n">clientAddrSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientAddr</span><span class="p">);</span> <span class="c1">//该变量必须初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">int</span> <span class="n">netfd</span> <span class="o">=</span>  <span class="nf">accept</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clientAddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clientAddrSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;netfd = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">netfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;client ip = %s, port = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="nf">inet_ntoa</span><span class="p">(</span><span class="n">clientAddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">clientAddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="n">clientArr</span><span class="p">[</span><span class="n">curidx</span><span class="p">].</span><span class="n">netfd</span> <span class="o">=</span> <span class="n">netfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">clientArr</span><span class="p">[</span><span class="n">curidx</span><span class="p">].</span><span class="n">is_alive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//1 表示存货 0表示已经断开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">clientArr</span><span class="p">[</span><span class="n">curidx</span><span class="p">].</span><span class="n">lastactive</span> <span class="o">=</span> <span class="nf">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>  <span class="c1">//初始化活跃时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">netfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">netfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>   <span class="c1">//将新连接加入到监听当中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">++</span><span class="n">curidx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 从readySet[i].data.fd 读取数据转发给其它所有存活的客户端
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">ssize_t</span> <span class="n">sret</span> <span class="o">=</span> <span class="nf">recv</span><span class="p">(</span><span class="n">readySet</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(</span><span class="n">sret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span><span class="c1">//客户端主动断开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">curidx</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span><span class="p">(</span><span class="n">clientArr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">netfd</span> <span class="o">==</span> <span class="n">readySet</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                            <span class="n">clientArr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_alive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_DEL</span><span class="p">,</span> <span class="n">clientArr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">netfd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">//移除监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="nf">close</span><span class="p">(</span><span class="n">clientArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">netfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">curidx</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">clientArr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_alive</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">clientArr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">netfd</span> <span class="o">==</span> <span class="n">readySet</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span> <span class="c1">//如果是已经断开的 or 自己本身 就跳过
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 广播操作，发送给其它所有的活跃客户端
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nf">send</span><span class="p">(</span><span class="n">clientArr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">netfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span><span class="n">curidx</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">clientArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">netfd</span> <span class="o">==</span> <span class="n">readySet</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                        <span class="n">clientArr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">lastactive</span> <span class="o">=</span> <span class="nf">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="c1">//SELECT操作如下，如同大海捞针的轮询操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">// for(int i = 0; i &lt; curidx; ++i){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//     if(clientArr[i].is_alive &amp;&amp; FD_ISSET(clientArr[i].netfd, &amp;rdset)){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//         //读取该客户端发送的消息并且转发给其它所有的客户端
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//         bzero(buf, sizeof(buf));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//         ssize_t sret = recv(clientArr[i].netfd, buf, sizeof(buf), 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//         if(sret == 0){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//             clientArr[i].is_alive = 0; //i号客户端已经终止
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//             FD_CLR(clientArr[i].netfd, &amp;monitorset);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//             close(clientArr[i].netfd);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//         }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//         //转发给其他所有的客户端
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//         for(int j = 0; j &lt; curidx; ++j){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//             if(j == i || clientArr[j].is_alive == 0){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//                 continue; //发送的目标是自己或者发送的目标已经关闭，就继续
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//             }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//             //相当于做一个广播的操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//            send(clientArr[j].netfd, buf, strlen(buf), 0);;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//         }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//     }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">curtime</span> <span class="o">=</span> <span class="nf">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;curtime = %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">curtime</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">       <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">curidx</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">           <span class="k">if</span><span class="p">(</span><span class="n">clientArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_alive</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">curtime</span> <span class="o">-</span> <span class="n">clientArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lastactive</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">               <span class="n">clientArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_alive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_DEL</span><span class="p">,</span> <span class="n">clientArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">netfd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="nf">close</span><span class="p">(</span><span class="n">clientArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">netfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">           <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>断线重连问题尚未修复</p>
<h2 id="非阻塞和阻塞的区别">非阻塞和阻塞的区别</h2>
<p>read操作的阻塞状况</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>是否会阻塞</th>
</tr>
</thead>
<tbody>
<tr>
<td>文件</td>
<td>不会阻塞</td>
</tr>
<tr>
<td>管道</td>
<td>会阻塞</td>
</tr>
<tr>
<td>stdin</td>
<td>会阻塞</td>
</tr>
<tr>
<td>socket</td>
<td>会阻塞</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="nf">read</span><span class="p">(</span><span class="err">磁盘文件</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret为0则退出</span><span class="err">；</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">recv</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span> <span class="err">一旦阻塞会陷入永久阻塞</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="把管道弄成非阻塞式">把管道弄成非阻塞式</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">setnonblock</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="nf">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">);</span> <span class="c1">//获取已经打开的fd的属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span><span class="o">|</span><span class="n">O_NONBLOCK</span><span class="p">;</span> <span class="c1">//增加一个非阻塞属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ERROR_CHECK</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;fcntl&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;1.pipe&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setnonblock</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">bzero</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">ssize_t</span> <span class="n">sret</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;sret = %ld, buf = %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sret</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> -1, <span class="nv">buf</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 3, <span class="nv">buf</span> <span class="o">=</span> hel
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> lo
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> -1, <span class="nv">buf</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> -1, <span class="nv">buf</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> -1, <span class="nv">buf</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 0, <span class="nv">buf</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 0, <span class="nv">buf</span> <span class="o">=</span> 
</span></span></code></pre></div><h2 id="5种io模型">5种IO模型</h2>
<ul>
<li>同步阻塞</li>
<li>同步非阻塞</li>
<li><strong>同步IO多路复用</strong></li>
<li>异步IO</li>
<li>信号驱动IO</li>
</ul>
<h2 id="epoll触发方式">EPOLL触发方式</h2>
<p>socket怎么让epoll就绪：当socket被关闭或者读缓冲区有数据（水平触发）时，则认为读操作是就绪的</p>
<ul>
<li>
<p>水平触发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">数据量
</span></span><span class="line"><span class="cl">  <span class="p">|</span>     _
</span></span><span class="line"><span class="cl">  <span class="p">|</span>    /  <span class="se">\_</span>_
</span></span><span class="line"><span class="cl">  <span class="p">|</span>___/_______<span class="se">\_</span>_____________t
</span></span></code></pre></div><p>只要数据量大于0，不管数据量是上升、平稳、或者下降，都会进行水平触发</p>
<ul>
<li></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">epoll <span class="nb">wait</span> ready!
</span></span><span class="line"><span class="cl"><span class="nv">buf</span> <span class="o">=</span> ni
</span></span><span class="line"><span class="cl">epoll <span class="nb">wait</span> ready!
</span></span><span class="line"><span class="cl"><span class="nv">buf</span> <span class="o">=</span> sh
</span></span><span class="line"><span class="cl">epoll <span class="nb">wait</span> ready!
</span></span><span class="line"><span class="cl"><span class="nv">buf</span> <span class="o">=</span> ig
</span></span><span class="line"><span class="cl">epoll <span class="nb">wait</span> ready!
</span></span><span class="line"><span class="cl"><span class="nv">buf</span> <span class="o">=</span> eh
</span></span><span class="line"><span class="cl">epoll <span class="nb">wait</span> ready!
</span></span><span class="line"><span class="cl"><span class="nv">buf</span> <span class="o">=</span> ao
</span></span><span class="line"><span class="cl">epoll <span class="nb">wait</span> ready!
</span></span><span class="line"><span class="cl"><span class="nv">buf</span> <span class="o">=</span> re
</span></span><span class="line"><span class="cl">epoll <span class="nb">wait</span> ready!
</span></span><span class="line"><span class="cl"><span class="nv">buf</span> <span class="o">=</span> n
</span></span></code></pre></div><p>可以看到epoll默认情况下时水平触发的</p>
<ul>
<li>边缘触发的处理</li>
</ul>
<p>某些情况下使用边缘触发会更加公平</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">数据量
</span></span><span class="line"><span class="cl">  <span class="p">|</span>     _
</span></span><span class="line"><span class="cl">  <span class="p">|</span>    /<span class="p">|</span>  <span class="se">\_</span>_
</span></span><span class="line"><span class="cl">  <span class="p">|</span>___/_<span class="p">|</span>______<span class="se">\_</span>_____________t
</span></span><span class="line"><span class="cl">       <span class="p">|</span>
</span></span><span class="line"><span class="cl"> 仅在该阶段进行触发
</span></span></code></pre></div><p>仅当数据处于上升沿时，才会导致边缘触发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="o">|</span><span class="n">EPOLLET</span><span class="p">;</span> <span class="c1">//读数据。增加边缘触发属性
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">epoll <span class="nb">wait</span> ready!
</span></span><span class="line"><span class="cl"><span class="nv">buf</span> <span class="o">=</span> ni
</span></span></code></pre></div><p>如果这样操作</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="n">sret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">sret</span> <span class="o">=</span> <span class="nf">recv</span><span class="p">(</span><span class="n">netfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;buf = %s </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>虽然能够收取到所有的消息，但是会阻塞在recv函数里</p>
<p>用while循环配合非阻塞</p>
<p>因此需要在recv中加上MSG_DONTWAIT参数（非阻塞）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">   <span class="nf">bzero</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">   <span class="n">sret</span> <span class="o">=</span> <span class="nf">recv</span><span class="p">(</span><span class="n">netfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">MSG_DONTWAIT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;sret = %ld, buf = %s </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sret</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span><span class="n">sret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">       <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">       <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;hehe</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">epoll <span class="nb">wait</span> ready!
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> ni 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> sh 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> ig 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> ah 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> ao 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> re 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> n
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> -1, <span class="nv">buf</span> <span class="o">=</span>  
</span></span><span class="line"><span class="cl">epoll <span class="nb">wait</span> ready!
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> ni 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> ha 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> oh 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> ua 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> 2, <span class="nv">buf</span> <span class="o">=</span> i
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nv">sret</span> <span class="o">=</span> -1, <span class="nv">buf</span> <span class="o">=</span>  
</span></span></code></pre></div></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://looechao.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://looechao.github.io/css/toc.css' />


<div id="gitalk-container" class="gitalk-container"></div>
<link rel="stylesheet" href='https://looechao.github.io/css/gitalk.css'>
<script src='https://looechao.github.io/js/gitalk.min.js'></script>
<script>
  const gitalk = new Gitalk({
    clientID: '4fad9f9325f73f2c2891',
    clientSecret: '109ed02ced3608e776a41f87de4ef9986f5b5fd6',
    repo: 'hugo-comments',
    owner: 'looechao',
    admin: ['looechao'],
    id: eval("location.pathname"), 
    distractionFreeMode: false 
  });
  (function() {
    gitalk.render('gitalk-container');
  })();
</script>


  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://looechao.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://looechao.github.io/js/github-style.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css"
  integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"
  integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"
  integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous"
  onload="renderMathInElement(document.body);"></script>





</html>